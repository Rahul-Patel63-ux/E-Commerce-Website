{% include 'base_assets/base_css.html' %}

<form id="edit_upi_form" action="{% url 'updateUpi' s.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 mb-4">
            <label for="uupi_accountant" class="form-label">UPI Accountant Name <span style="color:red;">*</span></label>
            <input type="text" id="uupi_accountant" class="form-control" name="uupi_accountant" value="{{ s.upi_accountant }}" placeholder="Ex: Kumar">
        </div>
        <div class="col-lg-12 col-md-12 col-sm-12 mb-4">
            <label for="uupi_name" class="form-label">UPI Name <span style="color:red;">*</span></label>
            <input type="text" id="uupi_name" class="form-control" name="uupi_name" value="{{ s.upi_name }}" placeholder="Ex: UPI">
        </div>
        <div class="col-lg-12 col-md-12 col-sm-12 mb-4">
            <label for="uupi_id" class="form-label">UPI ID <span style="color:red;">*</span></label>
            <input type="text" id="uupi_id" class="form-control" name="uupi_id" value="{{ s.upi_id }}" placeholder="Ex: user@upi">
        </div>
        <div class="col-lg-12 col-md-12 col-sm-12 mb-4">
            <label for="uupi_phonenumber" class="form-label">UPI Phone Number <span style="color:red;">*</span></label>
            <input type="text" id="uupi_phonenumber" class="form-control" name="uupi_phonenumber" value="{{ s.upi_phonenumber }}" placeholder="Ex: 9876543210">
            <span id="phone-error" class="error" style="color:red;"></span>
            <span id="phone-success" class="success" style="color:green;"></span>
        </div>
        <div class="col-lg-12 col-md-12 col-sm-12 mb-4">
            <label for="uupi_qr_image" class="form-label">UPI QR Code Image <span style="color:blue;">(Optional)</span></label>
            <input type="file" id="uupi_qr_image" class="form-control" name="uupi_qr_image">
            {% if s.upi_qr_image %}
                <img src="{{ s.upi_qr_image.url }}" alt="Current QR Code" style="width:50px;height:50px;margin-top:10px;">
            {% endif %}
        </div>
    </div>
    <div class="modal-footer d-flex justify-content-center">
        <button type="submit" id="editupiFormSubmit" class="btn text-white" style="background-color:#405189;">Save</button>
        <button type="button" class="btn bg-light" data-bs-dismiss="modal">Close</button>
    </div>
</form>

<!--base_assets js file-->
{% include 'base_assets/base_js.html' %}

<script>
$(document).ready(function() {
    // Function to capitalize first letter
    function capitalizeFirstLetter(str) {
        if (str.length > 0) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        return str;
    }

    // Custom validation methods
    $.validator.addMethod("capitalizeFirstLetter", function(value, element) {
        $(element).val(capitalizeFirstLetter(value));
        return true;
    }, "");

    $.validator.addMethod("letterStartNoLeadingSpace", function(value, element) {
        return this.optional(element) || /^[a-zA-Z][^\s].*/.test(value);
    }, "Name must start with a letter and have no leading space.");

    $.validator.addMethod("atLeastOneAlpha", function(value, element) {
        return this.optional(element) || /[a-zA-Z]/.test(value);
    }, "Please enter at least one alphabetical character.");

    $.validator.addMethod("noDoubleSpace", function(value, element) {
        return this.optional(element) || !/\s{2,}/.test(value);
    }, "Double spaces are not allowed.");

    $.validator.addMethod("alphaSpaceOnly", function(value, element) {
        return this.optional(element) || /^[a-zA-Z\s]*$/.test(value);
    }, "Only alphabetical characters and spaces are allowed.");

    $.validator.addMethod("validUpiId", function(value, element) {
        return this.optional(element) || /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/.test(value);
    }, "Please enter a valid UPI ID (e.g., user@upi).");

    $.validator.addMethod("validPhoneNumber", function(value, element) {
        return this.optional(element) || /^\d{10}$/.test(value);
    }, "Please enter a valid 10-digit phone number.");

<!--    $.validator.addMethod("validImage", function(value, element) {-->
<!--        if (element.files.length === 0) return true; // Allow empty for optional upload-->
<!--        const file = element.files[0];-->
<!--        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];-->
<!--        return validTypes.includes(file.type);-->
<!--    }, "Please upload a valid image file (JPEG, PNG, or GIF).");-->
    $.validator.addMethod("maxFileSize", function(value, element, param) {
        if (element.files && element.files.length > 0) {
            return element.files[0].size <= param * 1024 * 1024; // Convert MB to bytes
        }
        return true;
    }, "File size must not exceed {0}MB.");

    $('#edit_upi_form').validate({
        rules: {
            uupi_accountant: {
                required: true,
                alphaSpaceOnly: true,
                noDoubleSpace: true,
                letterStartNoLeadingSpace: true,
                atLeastOneAlpha: true,
                minlength: 2,
                maxlength: 50,
                capitalizeFirstLetter: true
            },
            uupi_name: {
                required: true,
                alphaSpaceOnly: true,
                noDoubleSpace: true,
                letterStartNoLeadingSpace: true,
                atLeastOneAlpha: true,
                minlength: 2,
                maxlength: 50,
                capitalizeFirstLetter: true
            },
            uupi_id: {
                required: true,
                validUpiId: true,
                maxlength: 100
            },
            uupi_phonenumber: {
                required: true,
                validPhoneNumber: true
            },
            uupi_qr_image: {
                extension: "jpg|png",
<!--                validImage: true-->
                maxFileSize :2
            }
        },
        messages: {
            uupi_accountant: {
                required: "Please enter the UPI accountant name.",
                alphaSpaceOnly: "Only alphabetical characters and spaces are allowed.",
                noDoubleSpace: "Double spaces are not allowed.",
                letterStartNoLeadingSpace: "Accountant name must start with a letter and have no leading space.",
                atLeastOneAlpha: "Please enter at least one alphabetical character.",
                minlength: "Accountant name should be at least 2 characters.",
                maxlength: "Accountant name should not exceed 50 characters."
            },
            uupi_name: {
                required: "Please enter the UPI name.",
                alphaSpaceOnly: "Only alphabetical characters and spaces are allowed.",
                noDoubleSpace: "Double spaces are not allowed.",
                letterStartNoLeadingSpace: "UPI name must start with a letter and have no leading space.",
                atLeastOneAlpha: "Please enter at least one alphabetical character.",
                minlength: "UPI name should be at least 2 characters.",
                maxlength: "UPI name should not exceed 50 characters."
            },
            uupi_id: {
                required: "Please enter the UPI ID.",
                validUpiId: "Please enter a valid UPI ID (e.g., user@upi).",
                maxlength: "UPI ID should not exceed 100 characters."
            },
            uupi_phonenumber: {
                required: "Please enter the phone number.",
                validPhoneNumber: "Please enter a valid 10-digit phone number."
            },
            uupi_qr_image: {
                extension:" Only .png, .jpg files are allowed",
<!--                validImage: "Please upload a valid image file (JPG, PNG)."-->
                maxFileSize: "Image size must not exceed 2MB"
            }
        },
        submitHandler: function(form) {
            console.log("Form is valid.");
            form.submit();
        }
    });
});
</script>